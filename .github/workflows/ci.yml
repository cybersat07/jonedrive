name: Run tests
on: push
jobs:
  test:
    name: Run tests
<<<<<<< HEAD
    runs-on: ubuntu-latest
=======
    runs-on: ubuntu-20.04
>>>>>>> 23bba13 (add c test suite to github actions)
    strategy:
      fail-fast: false
      matrix:
        account_type:
          - personal
          - business
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-go@v2
        with:
          go-version: "1.14"

      - name: Install apt dependencies
        run: |
          sudo apt update
<<<<<<< HEAD
          sudo apt install gcc pkg-config libwebkit2gtk-4.0-dev make wget rpm awscli libreoffice
=======
          sudo apt install gcc pkg-config libwebkit2gtk-4.0-dev dbus dbus-x11 make wget rpm awscli gdb systemd-coredump
          sudo rm /usr/local/bin/aws  # whyyy
>>>>>>> 23bba13 (add c test suite to github actions)

      - uses: actions/cache@v2
        with:
          path: |
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: Check go formatting
        run: |
          go get golang.org/x/tools/cmd/goimports
          [ -z "$(goimports -l .)" ]

      - name: Check that the app compiles successfully
        run: make
<<<<<<< HEAD
      
=======
        env:
          CFLAGS: -g

>>>>>>> 23bba13 (add c test suite to github actions)
      - name: Limit concurrent runs
        uses: softprops/turnstyle@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy auth tokens from S3
        run: |
<<<<<<< HEAD
          /usr/bin/aws s3 cp s3://fusefs-travis/$ACCOUNT_TYPE/.auth_tokens.json .
          /usr/bin/aws s3 cp s3://fusefs-travis/dmel.fa.gz .
=======
          which aws
          aws --version
          aws s3 cp s3://fusefs-travis/$ACCOUNT_TYPE/.auth_tokens.json .
          aws s3 cp s3://fusefs-travis/dmel.fa.gz .
>>>>>>> 23bba13 (add c test suite to github actions)
          gunzip dmel.fa.gz
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ACCOUNT_TYPE: ${{ matrix.account_type }}

      - name: Run c tests
        run: |
          sudo cp resources/onedriver@.service /etc/systemd/user
          sudo cp onedriver /usr/bin
          export XDG_RUNTIME_DIR="/run/user/$(id -u)"
          export DBUS_SESSION_BUS_ADDRESS="unix:path=${XDG_RUNTIME_DIR}/bus"
          sudo mkdir -p -m 0700 $XDG_RUNTIME_DIR
          sudo chown $(whoami). $XDG_RUNTIME_DIR
          sudo systemctl start user@$(id -u).service
          sudo systemctl status user@$(id -u).service
          systemctl status --user
          dbus-launch make c-test
        env:
          CFLAGS: -g

      - name: Run coredumpctl on failure
        run: |
          sleep 5
          coredumpctl dump > c-test.core
          printf 'bt\nq\n' > backtrace.gdb
          gdb -batch -x backtrace.gdb build/c-test c-test.core
        if: failure()

      - name: Run tests
        run: |
          go get -u github.com/rakyll/gotest 
          gotest -v -covermode=count -coverpkg=./fs/... -coverprofile=graph.coverage ./fs/graph
          gotest -v -covermode=count -coverpkg=./fs/... -coverprofile=fs.coverage ./fs
          go test -c -covermode=count -coverpkg=./fs/... ./fs/offline
          sudo ./unshare -n -S $(id -u) -G $(id -g) ./offline.test -test.v -test.coverprofile=offline.coverage

      - name: Copy new auth tokens to S3
        run: /usr/bin/aws s3 cp .auth_tokens.json s3://fusefs-travis/$ACCOUNT_TYPE/
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ACCOUNT_TYPE: ${{ matrix.account_type }}
        if: always()

      - name: Send coverage to Coveralls
        run: |
          go get github.com/mattn/goveralls
          go get github.com/wadey/gocovmerge
          gocovmerge *.coverage > coverage.out
          goveralls -coverprofile=coverage.out -service=github
        env:
          COVERALLS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
